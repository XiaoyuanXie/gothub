<html>
  <head>
    <title>Matrix Diagram</title>
    <script type="text/javascript" src="protovis-r3.2.js"></script>
    <!--<script type="text/javascript" src="data.js"></script>-->
    <!--<script type="text/javascript" src="followers_dist.js"></script>-->
    <!--<script type="text/javascript" src="followers_exp_dist.js"></script>-->
    <script type="text/javascript" src="followers_link_dist.js"></script>
    <!--<script type="text/javascript" src="followers_starter.js"></script>-->
    <!--<script type="text/javascript" src="followers_asym_exp_dist.js"></script>-->
    <!--<script type="text/javascript" src="followers_asym_dist.js"></script>-->
    <!--<script type="text/javascript" src="followers_act-exp-ratio_dist.js"></script>-->
    <!--<script type="text/javascript" src="followers_act-exp-div_dist.js"></script>-->
    <script type="text/javascript" src="jquery.min.js"></script>
    <style type="text/css">
      #fig {
        width: 400px;
        height: 400px;
      }
    </style>
  </head>
  <body><div id="center"><div id="fig">
    <script type="text/javascript+protovis">
//----------------------------------------------------------------------------

/* diverging: */
var colorDiverging = function(v) {
  if (v < 1/7) return "#B2182B";
  if (v < 2/7) return "#EF8A62";
  if (v < 3/7) return "#FDDBC7";
  if (v < 4/7) return "#F7F7F7";
  if (v < 5/7) return "#E0F3F8";
  if (v < 6/7) return "#67A9CF";
  return "#2166AC";
};

/* sequential: */
var colorSequential = function(v) {
  if (v < 1/7) return "#F1EEF6";
  if (v < 2/7) return "#D0D1E6";
  if (v < 3/7) return "#A6BDDB";
  if (v < 4/7) return "#74A9CF";
  if (v < 5/7) return "#3690C0";
  if (v < 6/7) return "#0570B0";
  return "#034E7B";
};

var degree = function(name, type) {
  var nodeIndex = undefined;
  $.each(data.nodes, function(index, node) {
    if (node.nodeName == name) {
      nodeIndex = index;
      return false;
    }
  });
  var degree = $.grep(data.links, function(link, index) {
    if (link[type] == nodeIndex) return true;
    return false;
  }).length;
  return degree;
};

var complement = function(source, target) {
  var results = $.grep(data.links, function(link, index) {
    if (link.source == target && link.target == source) {
      return true;
    }
  });
  var sum = 0;
  if (results.length > 0) {
    $.each(results, function(index, link) {
      sum += link.value;
    });
    //console.log(sum);
    return sum;
  } else {
    //console.log(0);
    return 0;
  }
}

var maxValue = 0;
$.each(data.links, function(index, link) {
  maxValue = Math.max(maxValue, link.value);
});

var maxDiff = 0;
$.each(data.links, function(index, link) {
  maxDiff = Math.max(maxDiff, Math.abs(link.value - complement(link.source, link.target)));
});

var scaleByMax = function(value, adjust) {
    return value / maxValue * adjust;
}

//----------------------------------------------------------------------------
var scaleFactor = 10;
var scale = function(value) {
    return scaleByMax(value, scaleFactor)
}

var color = colorSequential;

//----------------------------------------------------------------------------
var ranges = [];
var max_range = 7;
var scaleToDataRange = function(i) {
    return i / max_range / scaleFactor * maxValue;
};
for (i = 0; i < max_range; i++) {
    ranges[i] = scaleToDataRange(i);
}
//console.log(ranges)

var main = new pv.Panel()
    .width(300)
    .height(450);

var topPanel = main.add(pv.Panel)
    .width(200)
    .height(200)
    .top(90)
    .left(90);

/* Main Matrix display */
var layout = topPanel.add(pv.Layout.Matrix)
    .directed(true)
    .nodes(data.nodes)
    .links(data.links);

layout.link.add(pv.Bar)
  .fillStyle(function(l) { /*console.log(l);*/ return color(scale(l.linkValue)); })
    .antialias(false)
    .lineWidth(2);

layout.label.add(pv.Label)
    .font("12px sans-serif")
    .textStyle('black');

var gap = 15; // separates top and bottom panels

var getLegendText = function(i) {
    value = scaleToDataRange(i).toFixed(1);
    valuePlusOne = scaleToDataRange(i + 1).toFixed(1);
    if (i == 0) {return "< " + valuePlusOne};
    if (i == max_range - 1) {return "> " + value};
    return "[" + value + ", " + valuePlusOne + ")";
};

/* Legend */
var bottomPanel = main.add(pv.Panel)
    .width(200)
    .height(200)
    .top(300 + gap)
    .left(140);

var legend = bottomPanel.add(pv.Dot)
    .data(function() {return ranges})
    .left(0)
    .top(function() {return 0 + this.index * 15})
    .size(25)
    .strokeStyle(null)
    .fillStyle(function(d) {return color(scale(d))})
  .anchor("right").add(pv.Label)
    .left(15)
    .font("12px sans-serif")
    .textStyle('black')
    .text(function(d) {return getLegendText(this.index)})

main.render();

    </script>
  </div></div></body>
</html>
