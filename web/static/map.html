<html>
  <head>
    <title>Open Source Collaboration</title>
    <script type="text/javascript" src="http://polymaps.org/protodata.min.js?3.2"></script>
    <script type="text/javascript" src="http://polymaps.org/polymaps.min.js?2.2.0"></script>
    <script type="text/javascript" src="nns.min.js"></script>
    <script type="text/javascript" src="jshashtable.js"></script>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery-ui.min.js"></script>
    <script type="text/javascript" src="jquery.numberformatter.min.js"></script>
    <link type="text/css" href="ui-lightness/jquery-ui-1.8.6.custom.css" rel="stylesheet" />
    <style type="text/css">

        #map { position: relative; }

        .layer path {
            fill: lightsteelblue;
            fill-opacity: .5;
            /*stroke: steelblue;*/
        }

        .layer circle {
            fill: lightcoral;
            fill-opacity: .5;
            stroke: brown;
        }

        html
        {
            height:550px;
            width:1024px;
        }
        body {
            margin: 0;
            background: #E5E0D9;
        }

        svg {
            display: block;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        #copy {
            position: absolute;
            left: 0;
            bottom: 4px;
            padding-left: 5px;
            font: 9px sans-serif;
            color: #fff;
            cursor: default;
        }

        #copy a {
            color: #fff;
        }

        .compass .back {
            fill: #eee;
            fill-opacity: .8;
        }

        .compass .fore {
            stroke: #999;
            stroke-width: 1.5px;
        }

        .compass rect.back.fore {
            fill: #999;
            fill-opacity: .3;
            stroke: #eee;
            stroke-width: 1px;
            shape-rendering: crispEdges;
        }

        .compass .direction {
            fill: none;
        }

        .compass .chevron {
            fill: none;
            stroke: #999;
            stroke-width: 5px;
        }

        .compass .zoom .chevron {
            stroke-width: 4px;
        }

        .compass .active .chevron, .compass .chevron.active {
            stroke: #fff;
        }

        .compass.active .active .direction {
            fill: #999;
        }

        #title {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 0.25em;
        }
        #title h1 {
            color: white;
            font-weight: bold;
            font-size: 4.5em;
            font-family: Georgia, "Times New Roman", Times, serif;
            margin: 0;
            padding: 0;
        }

        #stats {
            width: 325px;
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 0.25em 1em;
        }
        #stats td {
            color: white;
            font-size: 2.25em;
            font-weight: bold;
            text-align: right;
            font-family: Georgia, "Times New Roman", Times, serif;
        }
        #stats td.label {
            font-weight: normal;
            color: #ddd;
            text-align: left;
        }
        #searchbox {
            background: inherit;
            border: 0;
            font-family: Georgia, "Times New Roman", Times, serif;
            color: white;
            font-weight: bold;
            font-size: 4.5em;
            height: inherit;
            width: 500px;
            padding: 0 0.25em;
        }
    </style>
    <script type="text/javascript">
        var urlParams = {};
        (function () {
            var e,
                a = /\+/g,  // Regex for replacing addition symbol with a space
                r = /([^&;=]+)=?([^&;]*)/g,
                d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
                q = window.location.search.substring(1);

            while (e = r.exec(q))
            urlParams[d(e[1])] = d(e[2]);
        })();

        var style = urlParams['style'];
        if (style == null)
            style = "midnight";

        var project;
        if ("project" in urlParams) project = urlParams["project"];
        else project = "";
        var lines;
        if ('lines' in urlParams) lines = eval(urlParams['lines']);
        else lines = true;
        var circles;
        if ('circles' in urlParams) circles = eval(urlParams['circles']);
        else circles = true;
        var names;
        if ('names' in urlParams) names = eval(urlParams['names']);
        else names = false;
        var scale;
        if ('scale' in urlParams) scale = eval(urlParams['scale']);
        else scale = 1;
        if ('linkAggregation' in urlParams) linkAggregation = urlParams['linkAggregation'] == 'True';
        else linkAggregation = false;
        if ('linkMaxScale' in urlParams) linkMaxScale = parseInt(urlParams['linkMaxScale']);
        else linkMaxScale = 0;

        var formatUrlParams = function(overrides) {
            overrides = overrides || {}
            first = true;
            formatted = '?';
            for (var key in urlParams) {
                formatted += (first ? '' : '&') + key + '=' + (overrides[key] || urlParams[key]);
                overrides[key] = undefined;
                first = false;
            }
            for (var key in overrides) {
                if (overrides[key]) {
                    formatted += (first ? '' : '&') + key + '=' + overrides[key]
                    first = false;
                }
            }
            return formatted;
        }

        var get_link_opacity = function(d, min_opacity) {
            temp = LINK_OPACITY_SCALE / d;
            if (temp < min_opacity){
                return min_opacity;
            }
            else {
                return temp;
            }
        }
        DOT_STROKE_OPACITY = 0.5;

        if (style == "original") {
            CLOUDMADE_MAP_ID = 998;
            DOT_FILL_COLOR = "green";
            DOT_STROKE_COLOR = "black";
            DOT_SCALE = 50;
            NAME_FILL_COLOR = "black";
            NAME_STROKE_COLOR = "green";
            NAME_OPACITY = 0.5;
            NAME_FONT_SIZE = 12;
            LINK_COLOR = "black";
            LINK_WIDTH = 3;
            LINK_OPACITY_SCALE = 10;
            LINK_MIN_OPACITY = 0.0;
        }
        else if (style == "midnight") {
            // original land color was #08314b
            // too dark: #062436
            // better: #072D43
            // still too dark: #06293D
            //CLOUDMADE_MAP_ID = 999;  // original midnight commander
            CLOUDMADE_MAP_ID = 28046; // midnight commander, minus ocean labels
            DOT_FILL_COLOR = "white";
            DOT_STROKE_COLOR = "white";
            DOT_SCALE = 25; // use 1 (!) for one month w/all projects
            NAME_FILL_COLOR = "black";
            NAME_STROKE_COLOR = "green";
            NAME_OPACITY = 0.5;
            NAME_FONT_SIZE = 12;
            LINK_COLOR = "white";
            LINK_WIDTH = 3;
            LINK_OPACITY_SCALE = 25;
            // try not to let this get too light:
            LINK_MIN_OPACITY = 0.02
        }
        else if (style == "blue") {
            // BH: would probably look quite nice if borders could be removed!!!
            // nice, bright blue from colorbrewer
            brightblue = "2C7FB8";
            CLOUDMADE_MAP_ID = 28028;
            DOT_FILL_COLOR = brightblue;
            DOT_STROKE_COLOR = "white";
            DOT_SCALE = 25;
            NAME_FILL_COLOR = "black";
            NAME_STROKE_COLOR = "green";
            NAME_OPACITY = 0.5;
            NAME_FONT_SIZE = 12;
            LINK_COLOR = brightblue;
            LINK_WIDTH = 3;
            LINK_OPACITY_SCALE = 25;
            LINK_MIN_OPACITY = 0.00;
        }

        var sortCircles = function(a, b)
        {
            return b.loc_count - a.loc_count;
        };

        var sortLinks = function(a, b)
        {
            return b[1] - a[1];
        };

        var linearScale = function(maxIndex, minValue, maxValue)
        {
            return function(index)
            {
                return minValue + (maxValue - minValue) * (index/maxIndex)
            }
        };

        var geoData = (function()
        {
            var data;
            var idx = 0;
            var point = null;
            var timeout = null;
            var showNext = function() {
                if (point != null)
                    map.remove(point)
                var obj = data[idx];
                idx = idx + 1;
                point = po.geoJson().features([
                    {
                    "geometry": {
                        "coordinates": [obj.long, obj.lat],
                        "type": "Point"
                    }
                    }]);
                map.add(point);
                timeout = setTimeout("geoData.showNext()", 100);
            };

            var setData = function(theData) {
                data = theData;
            };

            var stop = function() {
                clearTimeout(timeout);
            };

            return {
                setData : setData,
                showNext : showNext,
                stop : stop
            };
        })();

        $(document).ready(function() {
            map = null;
            po = org.polymaps;

            $(function(){
                map = po.map()
                    .container(document.getElementById("map").appendChild(po.svg("svg")))
                    .center({lat: 20, lon: 10})
                    .zoom(2)
                    .add(po.interact());

                map.add(po.image()
                    .url(po.url("http://{S}tile.cloudmade.com"
                    + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
                    + "/"
                    + CLOUDMADE_MAP_ID
                    + "/256/{Z}/{X}/{Y}.png")
                    .hosts(["a.", "b.", "c.", ""]))
                );

                /*
                map.add(po.geoJson()
                    .features([

                {
                "geometry": {
                    "coordinates": [-122.289365, 37.816873],
                    "type": "Point"
                }
                },
                {
                "geometry": {
                    "coordinates": [[[
                    [-122.289365, 37.816873],
                    [-122.273176, 37.812709],
                    [-122.278686, 37.807282],
                    [-122.291530, 37.810804],
                    [-122.289365, 37.816873]
                    ]]],
                    "type": "MultiPolygon"
                },
                "type": "Feature",
                "id": "beat:05X",
                "properties": {"name": "05X"}
                },
                {
                "geometry": {
                    "coordinates": [-121.289365, 37.816873],
                    "type": "Point"
                }
                },
                {
                "geometry": {
                    "coordinates": [-121.289365, 37.816873],
                    "type": "Point"
                }
                },
                {
                    "geometry" : { "type": "LineString",
                    "coordinates": [ [100.0, 0.0], [101.0, 1.0] ]
                    }
                }
                    ]).on('load', 
                            po.stylist().attr("stroke", function(d) { return "green"; })
                                        .attr("stroke-width", function(d) { return 5;})
                                        .attr("stroke-opacity", function(d) { return 0.2;})
                        )
                );
                map.add(po.compass()
                    .pan("none"));
                */
                $.ajax({
                    url: '/query' + formatUrlParams(),
                    dataType: "jsonp",
                    jsonpCallback: "jsonpcallback",
                    success: function(data, status)
                    {
                        link_data = data.links;
                        location_data = data.locations;
                        stats_data = data.stats;
                        //geoData.setData(data);
                        //geoData.showNext();
                        var arr = []
                        location_data.sort(sortCircles);
                        if (circles) {
                            for (var i = 0; i < location_data.length; i++) {
                                var l = location_data[i]
                                map.add(po.geoJson().features([
                                    {
                                        "geometry": {
                                            "coordinates": [ l.long, l.lat ],
                                            "type": "Point"
                                        },
                                        "size": l.loc_count
                                    }
                                ]).on(
                                    'load',
                                    function(e) {
                                        e.features.forEach(function(f) {
                                            var p = n$(f.element);
                                            /*
                                            p.on('mouseover', function() {
                                                point = n$(this);
                                                point.style('fill', 'black');
                                                point.style('opacity', 1);
                                            });
                                            p.on('mouseout', function() {
                                                point = n$(this);
                                                point.style('opacity', 'green');
                                                point.style('opacity', f.data.size / 2);
                                            });
                                            */
                                            p.style('fill', DOT_FILL_COLOR);
                                            p.style('stroke', DOT_STROKE_COLOR);
                                            p.style('stroke-opacity', DOT_STROKE_OPACITY);
                                            p.style('opacity', f.data.size / 2);
                                            p.attr('r', Math.sqrt(f.data.size * DOT_SCALE * scale));
                                        });
                                    }
                                ));

                                if (names) {
                                    map.add(po.geoJson().features([
                                        {
                                            "geometry": {
                                                "coordinates": [ l.long, l.lat ],
                                                "type": "Point"
                                            },
                                            "location": l.locations[0],
                                            "size": l.loc_count
                                        }
                                    ]).on(
                                        'load',
                                        function(e) {
                                            e.features.forEach(function(f) {
                                                var p = n$(f.element);
                                                p.attr('opacity', 0);
                                                if (f.data.location) {
                                                    var g = p.parent().add('svg:g', p);
                                                    g.attr('transform', p.attr('transform'));
                                                    var r = Math.sqrt(f.data.size * 50);
                                                    g.add('svg:text')
                                                        .attr('transform', 'translate(' + (r + 3) + ',' + (-r) + ')')
                                                        .style('fill', NAME_FILL_COLOR)
                                                        .style('stroke', NAME_STROKE_COLOR)
                                                        .style('opacity', NAME_OPACITY)
                                                        .style('font-size', NAME_FONT_SIZE)
                                                        .text(f.data.location);
                                                    /*
                                                    g.add('svg:rect')
                                                        .attr('x', -3)
                                                        .attr('y', -11)
                                                        .attr('width', text.element.offsetWidth)
                                                        .attr('height', 15)
                                                        .style('opacity', '0.5')
                                                        .style('fill', 'black');
                                                    */
                                                }
                                            });
                                        }
                                    ));
                                }
                            }
                        }
                        if (lines) {
                            link_data.sort(sortLinks);
                            var scaleFunc;
                            if (linkMaxScale)
                                scaleFunc = linearScale(linkMaxScale, 0.02, 0.3);
                            for (var i = 0; i < link_data.length; i++)
                            {
                                var l = link_data[i];
                                var strength = l[1];
                                var c = l[0];
                                var coords;
                                if (linkAggregation)
                                    coords = [ [c[0][0], c[0][1]], [c[1][0], c[1][1]] ];
                                else
                                    coords = [ [l[0][0], l[0][1]], [l[1][0], l[1][1]] ];
                                //arr.push([ [l[0].long, l[0].lat], [l[1].long, l[1].lat] ]);
                                map.add(po.geoJson().features([
                                    {
                                        "geometry": {
                                            "coordinates": coords,
                                            "type": "LineString"
                                        }
                                    }
                                ]).on(
                                    'load', (function(){
                                    var oVal = 0.02//get_link_opacity(link_data.length, LINK_MIN_OPACITY);
                                    if (linkAggregation && scaleFunc != null)
                                        oVal = scaleFunc(strength);
                                    return po.stylist().attr("stroke", LINK_COLOR)
                                                .attr("stroke-width", LINK_WIDTH)
                                                .attr("stroke-opacity", oVal);
                                    })()
                                ));
                            }
                        }
                        if (stats_data.author_count > 0) $('#people_count').text($.formatNumber(stats_data.author_count, {format:'#,###', locale:'us'}));
                        if (stats_data.commit_count > 0) $('#commit_count').text($.formatNumber(stats_data.commit_count, {format:'#,###', locale:'us'}));
                        if (stats_data.link_count > 0) $('#link_count').text($.formatNumber(stats_data.link_count, {format:'#,###', locale:'us'}));
                        $('#stats').show();
                        $('#project_name').text(project);
                        $('#fb').setValue(project);
                        $('#searchbox').attr('value', project);
                        /*map.add(po.geoJson()
                        .features([
                            {
                                "geometry": {
                                "coordinates": arr,
                                "type": "MultiLineString"
                                }
                            },
                            ]).on('load', 
                                    po.stylist()
                                                .attr("stroke-opacity", function(d) { return 0.2;}))
                        );*/
                    }
                });
            });

            $.fn.defaultText = function(value){
                var element = this.eq(0);
                element.data('defaultText',value);

                element.focus(function(){
                    if(element.val() == value){
                        element.val('').removeClass('defaultText');
                    }
                }).blur(function(){
                    if(element.val() == '' || element.val() == value){
                        element.addClass('defaultText').val(value);
                    }
                });

                return element.blur();
            }
            
            $('#searchbox').defaultText(project || 'Search...');
            $('#searchbox').autocomplete({
                source: '/projects',
                select: function(event, ui) {
                    window.location = '/static/map.html' + formatUrlParams({'project': ui.item.value});
                }
            });
        });
    </script>
    <!--<script type="text/javascript" src="map.js"></script>-->
  </head>
  <body>
    <div id="map">
        <div style="display:none;" id="stats">
            <table width="100%">
                <tr>
                    <td class="label"># people:</td>
                    <td id="people_count">0</td>
                </tr>
                <tr>
                    <td class="label"># commits:</td>
                    <td id="commit_count">0</td>
                </tr>
                <tr>
                    <td class="label"># links:</td>
                    <td id="link_count">0</td>
                </tr>
            </table>
        </div>
        <div id="title">
            <!--<div id="fb"></div>-->
            <input id="searchbox"/>
            <!--<h1 id="project_name"></h1>-->
        </div>
    </div>
  </body>
</html>

<!--
vim: ts=4 sw=4 sts=4 expandtab:
-->

