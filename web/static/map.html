<html>
  <head>
    <title>Open Source Collaboration</title>
    <script type="text/javascript" src="http://polymaps.org/protodata.min.js?3.2"></script>
    <script type="text/javascript" src="http://polymaps.org/polymaps.min.js?2.2.0"></script>
    <script type="text/javascript" src="nns.min.js"></script>
    <script type="text/javascript" src="jshashtable.js"></script>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="jquery.numberformatter.min.js"></script>
    <!--<script type="text/javascript" src="map.js"></script>-->
       <style type="text/css">

	#map { position: relative; }
    .layer path {
      fill: lightsteelblue;
      fill-opacity: .5;
      /*stroke: steelblue;*/
    }

    .layer circle {
      fill: lightcoral;
      fill-opacity: .5;
      stroke: brown;
    }

    html
	{
		height:800px;
		width:1024px;
	}
	
    body {
      margin: 0;
      background: #E5E0D9;
    }

    svg {
      display: block;
      overflow: hidden;
      width: 100%;
      height: 100%;
    }

    #copy {
      position: absolute;
      left: 0;
      bottom: 4px;
      padding-left: 5px;
      font: 9px sans-serif;
      color: #fff;
      cursor: default;
    }

    #copy a {
      color: #fff;
    }

    .compass .back {
      fill: #eee;
      fill-opacity: .8;
    }

    .compass .fore {
      stroke: #999;
      stroke-width: 1.5px;
    }

    .compass rect.back.fore {
      fill: #999;
      fill-opacity: .3;
      stroke: #eee;
      stroke-width: 1px;
      shape-rendering: crispEdges;
    }

    .compass .direction {
      fill: none;
    }

    .compass .chevron {
      fill: none;
      stroke: #999;
      stroke-width: 5px;
    }

    .compass .zoom .chevron {
      stroke-width: 4px;
    }

    .compass .active .chevron, .compass .chevron.active {
      stroke: #fff;
    }

    .compass.active .active .direction {
      fill: #999;
    }

    #title {
        position: absolute;
        top: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.5);
        padding: 0.25em 2em 1em;
    }
    #title h1 {
        color: white;
        font-weight: bold;
        font-size: 3em;
        font-family: Georgia, "Times New Roman", Times, serif;
        margin: 0;
        padding: 0;
    }

    #stats {
        position: absolute;
        top: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.5);
        padding: 0.5em 1em;
    }
    #stats td {
        color: white;
        font-weight: bold;
        font-family: Georgia, "Times New Roman", Times, serif;
    }
    #stats td.label {
        font-weight: normal;
        color: #ddd;
    }
        </style>
  </head>
  <body>
    <div id="map">
        <div id="stats">
            <table>
                <tr>
                    <td class="label"># people:</td>
                    <td id="people_count"/>
                </tr>
                <tr>
                    <td class="label"># commits:</td>
                    <td id="commit_count"/>
                </tr>
            </table>
        </div>
        <div id="title">
            <h1 id="project_name"></h1>
        </div>
    </div>
       <script type="text/javascript">
map = null;
po = org.polymaps;

$(function(){

    map = po.map()
        .container(document.getElementById("map").appendChild(po.svg("svg")))
	    .center({lat: -10, lon: 10})
	    .zoom(2)
        .add(po.interact());

    map.add(po.image()
        .url(po.url("http://{S}tile.cloudmade.com"
        + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
        + "/998/256/{Z}/{X}/{Y}.png")
        .hosts(["a.", "b.", "c.", ""]))
    );

/*    map.add(po.geoJson()
        .features([

    {
      "geometry": {
        "coordinates": [-122.289365, 37.816873],
        "type": "Point"
      }
    },
    {
      "geometry": {
        "coordinates": [[[
          [-122.289365, 37.816873],
          [-122.273176, 37.812709],
          [-122.278686, 37.807282],
          [-122.291530, 37.810804],
          [-122.289365, 37.816873]
        ]]],
        "type": "MultiPolygon"
      },
      "type": "Feature",
      "id": "beat:05X",
      "properties": {"name": "05X"}
    },
    {
      "geometry": {
        "coordinates": [-121.289365, 37.816873],
        "type": "Point"
      }
    },
    {
      "geometry": {
        "coordinates": [-121.289365, 37.816873],
        "type": "Point"
      }
    },
    {
        "geometry" : { "type": "LineString",
          "coordinates": [ [100.0, 0.0], [101.0, 1.0] ]
          }
    }
        ]).on("load", 
                po.stylist().attr("stroke", function(d) { return "green"; })
                            .attr("stroke-width", function(d) { return 5;})
                            .attr("stroke-opacity", function(d) { return 0.2;})
            )
    );
    map.add(po.compass()
        .pan("none"));
*/
    
    var project;
    if ("project" in urlParams) project = urlParams["project"];
    else project = "rails";
    var lines;
    if ('lines' in urlParams) lines = eval(urlParams['lines']);
    else lines = true;
    var circles;
    if ('circles' in urlParams) circles = eval(urlParams['circles']);
    else circles = true;
    var names;
    if ('names' in urlParams) names = eval(urlParams['names']);
    else names = false;
    var scale;
    if ('scale' in urlParams) scale = eval(urlParams['scale']);
    else scale = 1;
    $.ajax({
        url: '/query' + window.location.search,
        dataType: "jsonp",
        jsonpCallback: "jsonpcallback",
        success: function(data, status)
        {
            link_data = data.links;
            location_data = data.locations;
            stats_data = data.stats;
            //geoData.setData(data);
            //geoData.showNext();
            var arr = []
            if (lines) {
                for (var i = 0; i < link_data.length; i++)
                {
                    var l = link_data[i];
                    //arr.push([ [l[0].long, l[0].lat], [l[1].long, l[1].lat] ]);
                    map.add(po.geoJson().features([
                        {
                            "geometry": {
                                "coordinates": [ [l[0].long, l[0].lat], [l[1].long, l[1].lat] ],
                                "type": "LineString"
                            }
                        }
                    ]).on("load",
                            po.stylist().attr("stroke", "black")
                                        .attr("stroke-opacity", 0.2)
                                        .attr("r", 50)
                                        .style("fill", "black")
                                        .style("stroke", "black"))
                    );
                }
            }
            if (circles) {
                for (var i = 0; i < location_data.length; i++) {
                    var l = location_data[i]
                    map.add(po.geoJson().features([
                        {
                            "geometry": {
                                "coordinates": [ l.long, l.lat ],
                                "type": "Point"
                            },
                            "size": l.loc_count
                        }
                    ]).on(
                        'load',
                        function(e) {
                            e.features.forEach(function(f) {
                                var p = n$(f.element);
                                /*
                                p.on('mouseover', function() {
                                    point = n$(this);
                                    point.style('fill', 'black');
                                    point.style('opacity', 1);
                                });
                                p.on('mouseout', function() {
                                    point = n$(this);
                                    point.style('opacity', 'green');
                                    point.style('opacity', f.data.size / 2);
                                });
                                */
                                p.style('fill', 'green')
                                p.style('stroke', 'black')
                                p.style('opacity', f.data.size / 2)
                                p.attr('r', Math.sqrt(f.data.size * 50 * scale))
                            });
                        }
                    ));

                    if (names) {
                        map.add(po.geoJson().features([
                            {
                                "geometry": {
                                    "coordinates": [ l.long, l.lat ],
                                    "type": "Point"
                                },
                                "location": l.locations[0],
                                "size": l.loc_count
                            }
                        ]).on(
                            'load',
                            function(e) {
                                e.features.forEach(function(f) {
                                    var p = n$(f.element);
                                    p.attr('opacity', 0);
                                    if (f.data.location) {
                                        var g = p.parent().add('svg:g', p);
                                        g.attr('transform', p.attr('transform'));
                                        var r = Math.sqrt(f.data.size * 50);
                                        g.add('svg:text')
                                            .attr('transform', 'translate(' + (r + 3) + ',' + (-r) + ')')
                                            .style('fill', 'black')
                                            .style('stroke', 'green')
                                            .style('opacity', 0.5)
                                            .style('font-size', 12)
                                            .text(f.data.location);
                                        /*
                                        g.add('svg:rect')
                                            .attr('x', -3)
                                            .attr('y', -11)
                                            .attr('width', text.element.offsetWidth)
                                            .attr('height', 15)
                                            .style('opacity', '0.5')
                                            .style('fill', 'black');
                                        */
                                    }
                                });
                            }
                        ));
                    }
                }
            }
            $('#people_count').text($.formatNumber(stats_data.author_count, {format:'#,###', locale:'us'}));
            $('#commit_count').text($.formatNumber(stats_data.commit_count, {format:'#,###', locale:'us'}));
            $('#project_name').text(project);
            /*map.add(po.geoJson()
            .features([
                {
                    "geometry": {
                    "coordinates": arr,
                    "type": "MultiLineString"
                    }
                },
                ]).on("load", 
                        po.stylist()
                                    .attr("stroke-opacity", function(d) { return 0.2;}))
            );*/
        }
    });
});

var geoData = (function()
{
    var data;
    var idx = 0;
    var point = null;
    var timeout = null;
    var showNext = function()
    {
        if (point != null)
            map.remove(point)
        var obj = data[idx];
        idx = idx + 1;
        point = po.geoJson().features([
            {
              "geometry": {
                "coordinates": [obj.long, obj.lat],
                "type": "Point"
              }
            }]);
        map.add(point);
        timeout = setTimeout("geoData.showNext()", 100);
    };
    
    var setData = function(theData)
    {
        data = theData;
    };
    
    var stop = function()
    {
        clearTimeout(timeout);
    };
    
    return {
        setData : setData,
        showNext : showNext,
        stop : stop
    };
})();

var urlParams = {};
(function () {
    var e,
        a = /\+/g,  // Regex for replacing addition symbol with a space
        r = /([^&;=]+)=?([^&;]*)/g,
        d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
        q = window.location.search.substring(1);

    while (e = r.exec(q))
       urlParams[d(e[1])] = d(e[2]);
})();


        </script>
  </body>
</html>

<!-- 
vim: ts=4 sw=4 sts=4 expandtab:
-->

